<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DiamondMiner ‚Äì Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

  <style>
    /* fade in/out */
    .fade-in { animation: fadeIn 0.6s ease-in-out forwards; }
    .fade-out { animation: fadeOut 0.6s ease-in-out forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-15px); }
    }
    .animate-float { animation: float 4s ease-in-out infinite; }

    /* Sparkles */
    .sparkle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: radial-gradient(circle, rgba(0,255,255,1) 0%, rgba(0,255,255,0) 70%);
      border-radius: 50%;
      opacity: 0;
      animation: sparkle 2s infinite ease-in-out;
      pointer-events: none;
      display: none;
      filter: drop-shadow(0 0 6px rgba(0,255,255,0.6));
    }
    @keyframes sparkle {
      0%, 100% { transform: scale(0.6); opacity: 0; }
      50% { transform: scale(1.3); opacity: 1; }
    }
    .sparkle1 { top: 30%; left: 40%; animation-delay: 0s; }
    .sparkle2 { top: 50%; left: 60%; animation-delay: 0.6s; }
    .sparkle3 { top: 60%; left: 35%; animation-delay: 1.2s; }
    .sparkle4 { top: 40%; left: 55%; animation-delay: 1.8s; }
    .sparkle-active { display: block !important; animation-duration: 1.2s !important; filter: drop-shadow(0 0 18px rgba(0,255,255,0.9)) !important; }

    .island-glow { box-shadow: 0 30px 80px rgba(34,211,238,0.25), 0 0 40px rgba(34,211,238,0.12); transform: translateY(-4px); transition: all 0.25s ease; }
  </style>
</head>

<body class="bg-gradient-to-b from-slate-900 via-slate-800 to-slate-900 text-white min-h-screen fade-in">
  <!-- NAVBAR -->
  <header class="fixed top-0 left-0 w-full bg-[#05060d]/90 backdrop-blur-sm z-50 border-b border-white/5">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-6 py-4">
      <a href="index.html" class="flex items-center gap-3">
        <img src="images/diamond-icon.png" alt="DiamondMiner" class="w-8 h-8 animate-pulse" />
        <span class="text-xl font-bold text-cyan-400">DiamondMiner</span>
      </a>

      <nav class="flex gap-8 text-sm font-medium">
        <a href="index.html" class="text-gray-300 hover:text-cyan-400 transition">Home</a>
        <a href="dashboard.html" class="text-gray-300 hover:text-cyan-400 transition">Dashboard</a>
        <a href="marketplace.html" class="text-gray-300 hover:text-cyan-400 transition">Marketplace</a>
        <a href="tokenomics.html" class="text-gray-300 hover:text-cyan-400 transition">Tokenomics</a>
        <a href="whitepaper.html" class="text-gray-300 hover:text-cyan-400 transition">Whitepaper</a>
      </nav>

      <button id="disconnectBtn" class="text-sm text-red-400 hover:text-red-300 px-3 py-1 rounded-md border border-red-400/20 transition">
        Disconnect
      </button>
    </div>
  </header>
  <div class="pt-20"></div>

  <!-- MAIN DASHBOARD -->
  <main class="max-w-7xl mx-auto px-6 mt-12 grid md:grid-cols-2 gap-10 items-center">
    <!-- Island -->
    <div class="relative flex justify-center">
      <div id="islandWrap" class="relative">
        <img id="islandImg" src="images/floating-island.png" alt="Mining Island"
          class="w-full max-w-3xl mx-auto drop-shadow-[0_0_40px_rgba(34,211,238,0.3)] animate-float" />

        <div class="absolute -bottom-8 left-1/2 -translate-x-1/2 w-[60%] h-24 bg-cyan-400/30 blur-3xl rounded-full"></div>
        <div id="miningStatus"
          class="absolute bottom-8 left-1/2 -translate-x-1/2 text-cyan-300 text-sm font-semibold bg-black/60 px-4 py-2 rounded-full shadow-lg hidden">
          ‚õèÔ∏è Mining in progress...
        </div>

        <div class="sparkle sparkle1"></div>
        <div class="sparkle sparkle2"></div>
        <div class="sparkle sparkle3"></div>
        <div class="sparkle sparkle4"></div>
      </div>
    </div>

    <!-- Control Panel -->
    <div class="bg-slate-800/60 rounded-2xl p-8 shadow-2xl border border-white/10 backdrop-blur-sm">
      <h2 class="text-2xl font-bold text-cyan-400 mb-6 text-center">Mining Control Panel</h2>

      <button id="startMiningBtn"
        class="w-full py-3 bg-gradient-to-r from-cyan-400 to-blue-500 text-black font-bold rounded-lg shadow-md hover:scale-105 transition-transform duration-300">
        Start Mining
      </button>

      <div class="mt-6 space-y-4">
        <div>
          <p class="text-sm text-gray-400">CURRENT MINING RATE</p>
          <p id="miningRate" class="text-2xl font-bold text-cyan-300">0.00 $DIA / min</p>
        </div>
        <div>
          <p class="text-sm text-gray-400">MINING BALANCE</p>
          <p id="miningBalance" class="text-2xl font-bold text-cyan-300">0.00 $DIA</p>
        </div>
        <div>
          <p class="text-sm text-gray-400">TOTAL $DIA EARNED</p>
          <p id="totalDia" class="text-2xl font-bold text-green-400">0.00 $DIA</p>
        </div>
      </div>

      <button id="claimBtn"
        class="mt-8 w-full py-3 bg-gradient-to-r from-green-400 to-emerald-500 text-black font-bold rounded-lg shadow-md hover:scale-105 transition-transform duration-300">
        Claim Rewards
      </button>

      <!-- SWAP: inserted here, keeps the look consistent -->
      <div id="swapSection" class="mt-6 border-t border-white/10 pt-6">
        <h3 class="text-sm text-gray-300 mb-2">Swap $DIA ‚Üí $SOL (24h cooldown)</h3>

        <div class="flex items-center gap-3 mb-3">
          <div class="flex-1">
            <p class="text-xs text-gray-400">Available to swap (claimed $DIA)</p>
            <p id="swapAvailable" class="font-bold text-cyan-300">0.0000 $DIA</p>
          </div>
          <div class="w-44 text-right">
            <p class="text-xs text-gray-400">Rate</p>
            <p class="font-bold text-cyan-300">1 $DIA = <span id="diaToSolRateDisplay">0.0025</span> $SOL</p>
          </div>
        </div>

        <div class="mb-3 text-sm text-gray-400" id="swapCooldown">Next swap available: now</div>

        <div class="flex gap-3">
          <button id="swapBtn"
            class="flex-1 py-3 bg-gradient-to-r from-purple-500 to-indigo-500 text-black font-bold rounded-lg shadow-md hover:scale-105 transition-transform duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Swap to SOL
          </button>
        </div>

        <p id="solBalanceDisplay" class="mt-4 text-sm text-gray-300">SOL Balance: 0.0000 $SOL</p>
      </div>
      <!-- end swap -->
    </div>
  </main>

  <!-- WALLET MODAL -->
  <div id="walletModal" class="fixed inset-0 flex items-center justify-center bg-black/70 hidden z-50">
    <div class="bg-gray-900 p-8 rounded-2xl text-center shadow-2xl border border-cyan-400/40 w-[90%] max-w-sm">
      <h2 class="text-2xl font-bold text-cyan-400 mb-4">Connect Your Wallet</h2>
      <p class="text-gray-300 mb-6 text-sm">Please connect your Solana wallet to start mining $DIA tokens.</p>
      <button id="connectWalletBtn"
        class="w-full py-3 bg-gradient-to-r from-cyan-400 to-blue-500 text-black font-bold rounded-lg shadow-md hover:scale-105 transition-transform duration-300">
        Connect Wallet
      </button>
      <button onclick="closeWalletModal()" class="mt-4 text-gray-400 hover:text-cyan-300 text-sm">
        Cancel
      </button>
    </div>
  </div>

  <footer class="text-center py-6 text-xs text-slate-500 mt-10">
    ¬© 2025 DiamondMiner ‚Äî All Rights Reserved.
  </footer>

  <script>
    // ---------- DOM elements ----------
    const miningRateEl = document.getElementById("miningRate");
    const miningBalanceEl = document.getElementById("miningBalance");
    const totalDiaEl = document.getElementById("totalDia");
    const miningStatus = document.getElementById("miningStatus");
    const startBtn = document.getElementById("startMiningBtn");
    const disconnectBtn = document.getElementById("disconnectBtn");
    const connectWalletBtn = document.getElementById("connectWalletBtn");
    const islandImg = document.getElementById("islandImg");
    const sparkles = document.querySelectorAll(".sparkle");

    // swap DOM
    const swapBtn = document.getElementById("swapBtn");
    const swapAvailableEl = document.getElementById("swapAvailable");
    const swapCooldownEl = document.getElementById("swapCooldown");
    const solBalanceDisplay = document.getElementById("solBalanceDisplay");
    const diaToSolRateDisplay = document.getElementById("diaToSolRateDisplay");

    // ---------- Mining config ----------
    // Keep your original rate meaning: 0.05 = $DIA per minute
    const ratePerMinute = 0.05;
    const ratePerSecond = ratePerMinute / 60;

    // ---------- Swap config ----------
    const DIA_TO_SOL_RATE = 0.0025; // changeable fixed rate
    const SWAP_COOLDOWN_MS = 24 * 60 * 60 * 1000; // 24 hours in ms
    diaToSolRateDisplay.innerText = DIA_TO_SOL_RATE.toString();

    // ---------- State (per wallet) ----------
    let wallet = null;
    let balance = 0;      // unclaimed mining balance
    let totalDia = 0;     // total claimed (persisted)
    let solBalance = 0;   // simulated SOL balance (persisted)
    let miningActive = false;
    let lastMineTime = null;   // timestamp (ms) of last accrual
    let miningInterval = null;
    let nextSwapTime = null;   // timestamp (ms) when next swap allowed

    // ---------- Helpers ----------
    function updateUI() {
      miningBalanceEl.innerText = balance.toFixed(4) + " $DIA";
      totalDiaEl.innerText = totalDia.toFixed(4) + " $DIA";
      miningRateEl.innerText = ratePerMinute.toFixed(2) + " $DIA / min";

      // swap UI: allowed amount is the claimed totalDia (convention)
      swapAvailableEl.innerText = totalDia.toFixed(4) + " $DIA";
      solBalanceDisplay.innerText = "SOL Balance: " + solBalance.toFixed(4) + " $SOL";

      updateSwapCooldownUI();
    }

    function saveWalletData() {
      if (!wallet) return;
      const data = {
        balance,
        totalDia,
        solBalance,
        miningActive,
        lastMineTime,
        nextSwapTime
      };
      localStorage.setItem(wallet + "_data", JSON.stringify(data));
    }

    function loadWalletData(addr) {
      const raw = localStorage.getItem(addr + "_data");
      if (!raw) return null;
      try { return JSON.parse(raw); } catch (e) { return null; }
    }

    function toggleSparkles(active) {
      sparkles.forEach(s => s.style.display = active ? "block" : "none");
      islandImg.classList.toggle("island-glow", active);
    }

    // ---------- Mining tick (single precise increment using elapsed time) ----------
    function miningTick() {
      if (!miningActive || !lastMineTime) return;
      const now = Date.now();
      const elapsedSeconds = (now - lastMineTime) / 1000;
      if (elapsedSeconds <= 0) return;
      // accrue exactly elapsedSeconds * ratePerSecond
      balance += elapsedSeconds * ratePerSecond;
      lastMineTime = now;
      updateUI();
      saveWalletData();
    }

    // ---------- Start mining ----------
    function startMining(resume = false) {
      if (!wallet) return openWalletModal();
      if (miningActive) return; // already mining

      miningActive = true;
      lastMineTime = Date.now();
      miningStatus.classList.remove("hidden");
      startBtn.innerText = "Stop Mining";
      toggleSparkles(true);

      // persist that mining is active
      saveWalletData();

      // clear any previous interval, then start a 1s tick loop
      clearInterval(miningInterval);
      miningInterval = setInterval(miningTick, 1000);
    }

    // ---------- Stop mining ----------
    function stopMining() {
      if (!miningActive) return;
      // do a final tick to ensure no lost seconds
      miningTick();

      miningActive = false;
      clearInterval(miningInterval);
      startBtn.innerText = "Start Mining";
      miningStatus.classList.add("hidden");
      toggleSparkles(false);

      // save state
      saveWalletData();
    }

    // ---------- Claim ----------
    document.getElementById("claimBtn").addEventListener("click", () => {
      if (balance > 0) {
        // add unclaimed balance to total, then zero out balance
        totalDia += balance;
        balance = 0;
        updateUI();
        saveWalletData();
        alert("üíé Claimed! Total now: " + totalDia.toFixed(4) + " $DIA");
      } else {
        alert("‚ö†Ô∏è No rewards to claim yet!");
      }
    });

    // ---------- Swap helpers ----------
    function updateSwapCooldownUI() {
      if (!nextSwapTime) {
        swapCooldownEl.innerText = "Next swap available: now";
        if (swapBtn) swapBtn.disabled = (totalDia <= 0); // if no DIA claimed, disable
        return;
      }
      const now = Date.now();
      const remaining = nextSwapTime - now;
      if (remaining <= 0) {
        swapCooldownEl.innerText = "Next swap available: now";
        if (swapBtn) swapBtn.disabled = (totalDia <= 0);
        nextSwapTime = null;
        saveWalletData();
      } else {
        const hrs = Math.floor(remaining / 3600000);
        const mins = Math.floor((remaining % 3600000) / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        swapCooldownEl.innerText = `Next swap available in ${hrs}h ${mins}m ${secs}s`;
        if (swapBtn) swapBtn.disabled = true;
      }
    }

    // swap execution: converts totalDia (claimed) to SOL using DIA_TO_SOL_RATE
    function doSwap() {
      if (totalDia <= 0) {
        alert("‚ö†Ô∏è No claimed $DIA available to swap. Claim rewards first.");
        return;
      }
      // compute converted SOL
      const solGain = totalDia * DIA_TO_SOL_RATE;
      solBalance += solGain;
      // zero claimed DIA after swap
      totalDia = 0;
      // set cooldown
      nextSwapTime = Date.now() + SWAP_COOLDOWN_MS;
      updateUI();
      saveWalletData();
      alert(`üîÑ Swap complete ‚Äî received ${solGain.toFixed(4)} $SOL. Next swap available in 24 hours.`);
    }

    // attach swap handler (if element exists)
    if (swapBtn) {
      swapBtn.addEventListener("click", () => {
        // if button disabled, ignore (UI prevents click but double-check)
        if (swapBtn.disabled) return;
        // confirm
        const confirmSwap = confirm(`Swap all claimed $DIA (${totalDia.toFixed(4)} $DIA) to SOL at rate ${DIA_TO_SOL_RATE} SOL/DIA?`);
        if (!confirmSwap) return;
        doSwap();
      });
    }

    // ---------- Wallet modal helpers ----------
    function openWalletModal() { document.getElementById("walletModal").classList.remove("hidden"); }
    function closeWalletModal() { document.getElementById("walletModal").classList.add("hidden"); }

    // ---------- Connect wallet ----------
    async function connectWallet() {
      if (window.solana && window.solana.isPhantom) {
        try {
          const resp = await window.solana.connect();
          wallet = resp.publicKey.toString();
          localStorage.setItem("walletAddress", wallet);
          closeWalletModal();

          // load wallet data and possibly resume
          const saved = loadWalletData(wallet) || {};
          balance = parseFloat(saved.balance || 0);
          totalDia = parseFloat(saved.totalDia || 0);
          solBalance = parseFloat(saved.solBalance || 0);
          nextSwapTime = saved.nextSwapTime || null;
          const wasMining = !!saved.miningActive;
          const savedLast = saved.lastMineTime || null;

          if (wasMining && savedLast) {
            // award offline earnings exactly as if mining continued
            const now = Date.now();
            const elapsedSeconds = (now - savedLast) / 1000;
            if (elapsedSeconds > 0) {
              balance += elapsedSeconds * ratePerSecond;
            }
            lastMineTime = now;
            miningActive = true;
            // start loop
            startMining(true);
          } else {
            miningActive = false;
            lastMineTime = null;
            updateUI();
            saveWalletData();
          }

        } catch (err) {
          console.error("Wallet connection cancelled:", err);
        }
      } else {
        alert("‚ö†Ô∏è Phantom wallet not found. Please install it from https://phantom.app/");
      }
    }
    connectWalletBtn.addEventListener("click", connectWallet);

    // ---------- Disconnect ----------
    disconnectBtn.addEventListener("click", () => {
      // stop mining but keep wallet data stored under wallet + "_data"
      stopMining();

      // remove active wallet only, keep its data saved
      localStorage.removeItem("walletAddress");
      wallet = null;

      // fade-out to home (same UX as before)
      document.body.classList.add("fade-out");
      setTimeout(() => (window.location.href = "index.html"), 600);
    });

    // ---------- Start button behavior ----------
    startBtn.addEventListener("click", () => {
      if (!wallet) {
        // if there's no wallet currently in memory, try to read stored walletAddress
        const savedWallet = localStorage.getItem("walletAddress");
        if (!savedWallet) return openWalletModal();
        // else use saved wallet and load its data
        wallet = savedWallet;
        const saved = loadWalletData(wallet) || {};
        balance = parseFloat(saved.balance || 0);
        totalDia = parseFloat(saved.totalDia || 0);
        solBalance = parseFloat(saved.solBalance || 0);
        nextSwapTime = saved.nextSwapTime || null;
        const wasMining = !!saved.miningActive;
        const savedLast = saved.lastMineTime || null;

        if (wasMining && savedLast) {
          const now = Date.now();
          const elapsedSeconds = (now - savedLast) / 1000;
          if (elapsedSeconds > 0) balance += elapsedSeconds * ratePerSecond;
          lastMineTime = now;
          miningActive = true;
          startMining(true);
          return;
        } else {
          updateUI();
          startMining();
          return;
        }
      }

      // Toggle mining if wallet exists
      if (miningActive) stopMining();
      else startMining();
    });

    // ---------- Load on page startup ----------
    document.addEventListener("DOMContentLoaded", () => {
      // Check wallet presence
      const savedWallet = localStorage.getItem("walletAddress");
      if (!savedWallet) {
        // keep previous behavior: redirect to home if no wallet
        document.body.classList.add("fade-out");
        setTimeout(() => (window.location.href = "index.html"), 600);
        return;
      }

      // set wallet and load its data
      wallet = savedWallet;
      const saved = loadWalletData(wallet) || {};
      balance = parseFloat(saved.balance || 0);
      totalDia = parseFloat(saved.totalDia || 0);
      solBalance = parseFloat(saved.solBalance || 0);
      nextSwapTime = saved.nextSwapTime || null;
      const wasMining = !!saved.miningActive;
      const savedLast = saved.lastMineTime || null;

      if (wasMining && savedLast) {
        // offline accrual: compute elapsed seconds since lastMineTime and add exact amount
        const now = Date.now();
        const elapsedSeconds = (now - savedLast) / 1000;
        if (elapsedSeconds > 0) {
          balance += elapsedSeconds * ratePerSecond;
        }
        lastMineTime = now;
        miningActive = true;
        // update UI and start tick loop
        updateUI();
        startMining(true);
      } else {
        miningActive = false;
        lastMineTime = null;
        updateUI();
      }

      // update swap cooldown UI every second
      setInterval(updateSwapCooldownUI, 1000);
    });

    // ---------- Page Visibility & Unload Persistence ----------
    // Save a final tick + timestamp when the page is being unloaded/closed
    window.addEventListener("beforeunload", () => {
      if (miningActive) {
        // run final accrual (ensures lastMineTime is up-to-date)
        miningTick();
        saveWalletData();
      } else {
        // still save state
        saveWalletData();
      }
    });

    // When the page is hidden (user switches tab or minimizes), store the timestamp so offline accrual works.
    document.addEventListener("visibilitychange", () => {
      if (!wallet) return;
      if (document.visibilityState === "hidden") {
        if (miningActive) {
          // apply final tick and persist lastMineTime (this marks the time the user left)
          miningTick();
          saveWalletData();
        } else {
          // just persist current state
          saveWalletData();
        }
      } else if (document.visibilityState === "visible") {
        // When visible again, compute offline accrual between saved lastMineTime and now if miningActive
        const saved = loadWalletData(wallet);
        if (saved && saved.miningActive && saved.lastMineTime) {
          const now = Date.now();
          const elapsedSeconds = (now - saved.lastMineTime) / 1000;
          if (elapsedSeconds > 0) {
            balance += elapsedSeconds * ratePerSecond;
          }
          lastMineTime = now;
          miningActive = true;
          updateUI();
          // restart the tick loop if not already running
          clearInterval(miningInterval);
          miningInterval = setInterval(miningTick, 1000);
        }
      }
    });

    // Expose stopMining for other handlers if needed
    window.stopMining = stopMining;
  </script>
</body>
</html>
